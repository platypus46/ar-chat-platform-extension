{% load static %}
<html>
  <head>
    <meta charset="UTF-8">
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>
      eruda.init();
    </script>

    
    <!-- ë¡œë¹„í™”ë©´ -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'lobby/css/lobby.css' %}"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'lobby/js/profile.js' %}"></script>
    <script src="{% static 'lobby/js/gpt_api_key.js' %}"></script>
    <script type="text/javascript">
      var recordButtonModel = "{% static 'lobby/img_model/record_button.glb' %}";
      var recordStopButtonModel = "{% static 'lobby/img_model/record_stop_button.glb' %}";
    </script>

    <!-- ARí™”ë©´ -->
    <script src="https://threejs.org/build/three.js"></script>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras@0.1.2/dist/aframe-physics-extras.min.js"></script>
    <script src="{% static 'tools/aframe-hand-tracking-controls-extras.js' %}"></script>
    <script src="{% static 'tools/hand-tracking-controls-extras-components.js' %}"></script>
    <link rel="stylesheet" href="{% static 'lobby/css/AR.css' %}" />
    <link rel="stylesheet" href="{% static 'lobby/css/lobby.css' %}" />
    <script src="{% static 'lobby/js/AR_setting.js' %}"></script>
    <script src="{% static 'lobby/js/shop.js' %}"></script>
  </head>
  <body>
    <div>
      <h1 id="title">PLATYVERSE ì‚¬ì „ì„¤ì •</h1>
      <div class="user-notification">{{ full_name }}ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.</div>
      <div class="profile-container">
        <img
          src="{{ profile_picture_url }}"
          alt="{{ username }}ì˜ í”„ë¡œí•„ ì‚¬ì§„"
          class="profile-pic"
          id="userProfilePic"
        />
        <input type="file" id="imageUpload" style="display: none" />
        <button id="refreshProfile">í”„ë¡œí•„ ì ìš©</button> 
    </div>
    </div>
    <!-- ì„ì‹œ ìƒì  ë²„íŠ¼ -->
    <div id="icon-button-container">
      <img
        id="icon-button"
        src="{% static 'lobby/icon/shop_test_icon.png' %}"
        alt="Shop Icon"
      />
    </div>

    <!-- JavaScript ë¶€ë¶„ -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const username = "{{ user.username }}"; // Django templateì—ì„œ í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ usernameì„ ê°€ì ¸ì˜´
        const iconButton = document.getElementById("icon-button");

        iconButton.addEventListener("click", function () {
          window.location.href = `/shop/${username}`; // URLë¡œ ì´ë™
        });
      });
    </script>
    {% block content %}
    <div class="container">
      <div class="gpt-api-key-section">
        <h2>GPT API Key</h2>
        <form id="gptApiKeyForm" method="post">
          {% csrf_token %}
          <div class="input-group">
            <input
              type="text"
              id="gptApiKey"
              name="gptApiKey"
              placeholder="ì—¬ê¸°ì— gpt api í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
              value="{{ gpt_api_key }}"
            />
            <button type="submit" id="saveApiKeyBtn">ì €ì¥</button>
          </div>
        </form>
      </div>
    </div>
    {% endblock %}
    <div class="subscriber-list">
      <h3>êµ¬ë… ëª©ë¡</h3>
      <div class="scrollable-content">
          {% for subscription in subscriptions %}
          <div class="subscriber-item">
              {{ subscription.service.name }}
              {% for type in subscription.types.all %}
                  {% if type.name == "Hand" %}
                      <img src="/static/lobby/img/hand.png" alt="Hand">
                  {% elif type.name == "Controller" %}
                      <img src="/static/lobby/img/controller.png" alt="Controller">
                  {% endif %}
              {% endfor %}
          </div>
          {% empty %}
          <div>êµ¬ë… ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          {% endfor %}
      </div>
    </div>

    <div
      id="chatOverlay"
      style="
        display: none;
        z-index: 1000;
        position: fixed;
        top: 30%;
        right: 10px;
      "
    >
      <div id="chatHeader">
        <span id="chatFriendName"></span>
        <button id="closeChat">ë‹«ê¸°</button>
      </div>
      <div id="chatMessages">
        <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
      <div id="chatInputSection">
        <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
        <button id="sendChatMessage">ì „ì†¡</button>
      </div>
    </div>
    <div
      id="notificationSection"
      style="position: fixed; top: 20px; right: 20px; z-index: 1000"
    >
      <button id="notificationIcon">ğŸ””</button>
      <ul
        id="notificationList"
        style="
          display: none;
          position: absolute;
          top: 30px;
          right: 0;
          background-color: #fff;
          border: 1px solid #ccc;
          padding: 10px;
          z-index: 1000;
        "
      >
        {% for notification in notifications %}
        <li class="notificationElementClass" data-id="{{ notification.id }}">
          {{ notification.message }}
          <button class="acceptFriendRequest" data-id="{{ notification.id }}">
            ìˆ˜ë½
          </button>
          <button class="closeNotification" data-id="{{ notification.id }}">
            ë‹«ê¸°
          </button>
        </li>
        {% endfor %}
      </ul>
    </div>
    <div id="friendListSection">
      <ul id="friendNames">
        {% for friend in friends %}
        <li>
          <!-- í”„ë¡œí•„ ì‚¬ì§„ ì¶”ê°€ -->
          {% if friend.profile_picture %}
            <img src="{{ friend.profile_picture.url }}" alt="{{ friend.full_name }}'s profile picture" width="50" height="50">
          {% endif %}
          <span>{{ friend.full_name }}</span>
          <button
            class="deleteFriendButton"
            data-username="{{ friend.username }}"
            onclick="deleteFriend('{{ friend.username }}')"
          >
            ì‚­ì œ
          </button>
          <button
            class="chatFriendButton"
            onclick="chatWithFriend('{{ friend.username }}')"
          >
            ì±„íŒ…
          </button>
        </li>
        {% endfor %}
      </ul>
      <div id="friendAddSection">
        <input type="text" id="newFriendName" placeholder="ì¹œêµ¬ ì•„ì´ë”” ì…ë ¥" />
        <button id="addFriendButton">ì¹œêµ¬ ì¶”ê°€</button>
      </div>
    </div>

    <!-- ë¡œë”© ìŠ¤í¬ë¦° -->
    <div
      id="loadingScreen"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
      "
    >
      <div class="loader"></div>
    </div>
    <a-scene
      physics="debug: true"
      light="defaultLightsEnabled:false"
      data-font-json="{% static 'lobby/font/NanumGothic-Bold.json' %}"
      data-font-png="{% static 'lobby/font/NanumGothic-Bold.png' %}"
      auto-font
      scene-debounced-click

      screenshot="width: 1920; height: 1080;"
    >
      <a-light type="ambient" color="#888"></a-light>
      <a-light
        type="directional"
        color="#FFF"
        intensity="1"
        position="2 4 -3"
      ></a-light>

      <!-- ì™¼ì† ì»¨íŠ¸ë¡¤ëŸ¬ -->
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable"></a-entity>

      <!-- ì˜¤ë¥¸ì† ì»¨íŠ¸ë¡¤ëŸ¬ -->
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>
      <a-entity
        id="leftHand"
        hand-tracking-controls="hand: left;"
        hand-tracking-extras
        ><a-entity
          finger-cursor
          raycaster="objects: .clickable; far: 0.03"
        ></a-entity
      ></a-entity>
      <a-entity
        id="rightHand"
        hand-tracking-controls="hand: right;"
        hand-tracking-extras
      >
        <a-entity
          finger-cursor
          raycaster="objects: .clickable; far: 0.03"
        ></a-entity>
      </a-entity>
      <a-camera id="camera">
        <a-entity id="Text" position="-0.12 -0.1 -0.45" visible="false">
          <a-entity id= "roundBox" rounded-box="width: 0.12; height: 0.15; depth: 0.01; radius: 0.02; color: #D8BFD8" position="0 -0.08 -0.02">
            <a-entity rounded-Box="width:0.09; height: 0.11; depth: 0.011; radius: 0.02; color: #800080" position="-0.009 0.013 0">
              <a-text
                id="sttText"
                position="-0.04 0.04 0.01"
                value="PLATYVERSE"
                color="#FFFFFF"
                shader="msdf"
                width="0.3"
                font="https://raw.githubusercontent.com/myso-kr/aframe-fonts-korean/master/fonts/ofl/nanumgothic/NanumGothic-Bold.json"
              ></a-text>
            </a-entity> 
            <a-circle id= subRecordButton radius="0.006" color="red" position="0.05 0.055 0.011" class="clickable"></a-circle>
            <a-circle id="specialCharacters" radius="0.008" color="#D3D3D3" position="0.05 0.035 0.011" class="clickable">
              <a-text value="123" position="0.001 0 0.01" align="center" scale="0.5 0.5 0.5" ></a-text>
            </a-circle>
            <a-circle radius="0.008" color="#D3D3D3" position="0.05 0.015 0.011" class="clickable">
              <a-entity troika-text="value: ğŸ˜Š ; fontSize: 0.008; color: white;" position="0.001 0 0.01"></a-entity>
            </a-circle>
            <a-entity id= "backSpacebar" rounded-plane-box="width:0.02; height: 0.04; radius: 0.004; color: #D3D3D3;" position="0.05 -0.03 0.011" class="clickable">
              <a-text value="back" align="center" baseline="center" color="black" width="0.02" position="0 0 0.001"></a-text>
            </a-entity>
            <a-entity id="spaceBar" rounded-plane-box="width:0.07; height: 0.018; radius: 0.006; color: #D3D3D3;" position="-0.01 -0.06 0.011" class="clickable">
              <a-text value="space" align="center" baseline="center" color="black" width="0.06" position="0 0 0.001"></a-text>
            </a-entity>
            <a-entity id="charPagerToolbar" char-pager position="0 -0.06 0.01" visible="false"></a-entity>
          </a-entity>
          <!-- Char Pager íˆ´ë°” (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
          <a-box id="talkToolbar" position="0 0 0" rotation="0 0 0" width="0.13" height="0.02" depth="0.005" color="#888888">
            <a-cylinder
              position="0.05 0 0.01"
              radius="0.007"
              height="0.007"
              color="white"
              rotation="90 0 0"
              class="clickable"
              id="chatScroll"
            ></a-cylinder>
            <a-box position="-0.01 0 0.01" rotation="0 0 0" width="0.08" height="0.014" depth="0.002" color="white">
              <a-text id="subTextbar" value="platyverse" color="black" position="-0.04 0 0"></a-text>
            </a-box>
          </a-box>
          <a-box id="talkUIbox" position="0 -0.09 0" rotation="0 0 0" width="0.13" height="0.16" depth="0.01" color="#D3D3D3"></a-box>
        </a-entity>        
        <a-entity id="hideUIButton" position="-0.08 -0.2 -0.43" visible="false">
          <a-cylinder
            geometry="radius: 0.012; height: 0.01; segmentsRadial: 32"
            material="color: yellow"
            rotation="90 0 0"
            class="clickable"
          ></a-cylinder>
        </a-entity>
        <a-entity
          id="ui"
          rounded-box="width: 0.3; height: 0.45; depth: 0.001; radius: 0.04; color: #D8BFD8" 
          material="opacity: 0.5; transparent: true; "
          position="0.1 0 -0.5"
          visible="false"
        >
        <a-entity
          id="profile"
          geometry="primitive: plane; width: 0.2; height: 0.2"
          material="src: {{ profile_picture_url }};"
          position="0 0.06 0.01"
        ></a-entity>
          <a-entity
            id="friend"
            geometry="primitive: plane; width:0.2; height: 0.23"
            material="color:green"
            position="0 0.1 -0.01"
            visible="false"
          >
            <a-entity
              id="friendHeader"
              geometry="primitive: plane; width:0.15; height: 0.03"
              material="color:yellow"
              position="0 0.11 0"
            ></a-entity>
            <a-entity
              id="friendsContainer"
              position="0 -0.1 0"
              width="0.2"
              height="0.15"
            >
            </a-entity>
          </a-entity>
          <a-entity
            id="Misc"
            geometry="primitive: plane; width:0.2; height: 0.2"
            material="color:purple"
            position="0 0 -0.01"
            visible="false"
          >
            <a-entity
              id="MiscContainer"
              position="0 -0.025 0"
              width="0.2"
              height="0.15"
            ></a-entity>
          </a-entity>
          <a-entity id="uibuttons">
            <a-entity
              id="chatbutton"
              geometry="primitive: circle; radius: 0.03"
              material="color: white"
              position="-0.07 -0.1 0.05"
              class="clickable"
            >
              <a-text
                value="chat"
                align="center"
                color="black"
                position="0 0 0.001"
                width="0.5"
              ></a-text>
            </a-entity>
            <a-entity
              id="Miscbutton"
              geometry="primitive: circle; radius: 0.03"
              material="color: white"
              position="0.06 -0.1 0.05"
              class="clickable"
            >
              <a-text
                value="misc"
                align="center"
                color="black"
                position="0 0 0.001"
                width="0.3"
              ></a-text>
            </a-entity>
          </a-entity>
          <a-entity id="pagenation">
            <a-triangle
              id="left_pagenation"
              vertex-a="0.017 0.017 0"
              vertex-b="-0.017 0.017 0"
              vertex-c="0 -0.017 0"
              material="color: #D7DF01"
              position="-0.04 -0.17 0"
              rotation="0 0 -90">
            </a-triangle>
            <a-entity id="pageInfo" position="0.15 -0.17 0" text="value: 1/1; color: white;"></a-entity>
            <a-triangle
              id="right_pagenation"
              vertex-a="0.017 0.017 0"
              vertex-b="-0.017 0.017 0"
              vertex-c="0 -0.017 0"
              material="color: #D7DF01"
              position="0.06 -0.17 0"
              rotation="0 0 90">
            </a-triangle>
          </a-entity>
          <a-entity id="ui-info">
            <a-entity
              id="language-mode"
              geometry="primitive: circle; radius: 0.01"
              material="color: white"
             position="-0.11 0.19 0.01"
              class="clickable">
                <a-text value="EN" position="0 0 0.001" align="center" color="black"></a-text>
            </a-entity>
            <a-entity rounded-box="width: 0.12; height: 0.02; depth: 0.001; radius: 0.003; color: white" position="0.07 0.19 0.001">
              <a-text value="user: {{ username }}" position="0 0 0.002" align="center" color="black" font="size: 0.02"></a-text>
            </a-entity>
          </a-entity>
         
        </a-entity>

        <a-entity id="colorSelectorGroup" position="0.03 0 0" visible="false">
          <!-- ì„ íƒëœ ìƒ‰ê¹”ì„ ë³´ì—¬ì¤„ êµ¬ -->
          <a-sphere id="selectedColorSphere" position="0 -0.25 -0.55" radius="0.03" color="#888888" class="clickable"></a-sphere>

          <!-- íŒ”ë ˆíŠ¸ ê·¸ë£¹ -->
          <a-entity id="palette" position="0 0 -0.5">
            <a-box id="redBox" position="-0.09 -0.3 0" scale="0.03 0.03 0.03" color="#FF0000" data-color="#FF0000" class="clickable"></a-box> <!-- ë¹¨ê°• -->
            <a-box id="orangeBox" position="-0.06 -0.3 0" scale="0.03 0.03 0.03" color="#FFA500" data-color="#FFA500" class="clickable"></a-box> <!-- ì£¼í™© -->
            <a-box id="yellowBox" position="-0.03 -0.3 0" scale="0.03 0.03 0.03" color="#FFFF00" data-color="#FFFF00" class="clickable"></a-box> <!-- ë…¸ë‘ -->
            <a-box id="greenBox" position="0 -0.3 0"   scale="0.03 0.03 0.03" color="#008000" data-color="#008000" class="clickable"></a-box>  <!-- ì´ˆë¡ -->
            <a-box id="blueBox" position="0.03 -0.3 0" scale="0.03 0.03 0.03" color="#0000FF" data-color="#0000FF" class="clickable"></a-box>  <!-- íŒŒë‘ -->
            <a-box id="violetBox" position="0.06 -0.3 0" scale="0.03 0.03 0.03" color="#4B0082" data-color="#4B0082" class="clickable"></a-box> <!-- ë‚¨ìƒ‰ -->
            <a-box id="purpleBox" position="0.09 -0.3 0" scale="0.03 0.03 0.03" color="#800080" data-color="#800080" class="clickable"></a-box> <!-- ë³´ë¼ -->
          </a-entity>
        </a-entity>
        
        <!-- Left Control Buttons -->
        <a-entity position="0.04 -0.27 -0.4" id="xypad" visible="false">
          <a-box
            position="0 0.04 0"
            width="0.04"
            height="0.04"
            depth="0.02"
            color="gray"
            class="clickable"
            id="up"
          ></a-box>
          <a-box
            position="0 -0.04 0"
            width="0.04"
            height="0.04"
            depth="0.02"
            color="gray"
            class="clickable"
            id="down"
          ></a-box>
          <a-box
            position="-0.04 0 0"
            width="0.04"
            height="0.04"
            depth="0.02"
            color="gray"
            class="clickable"
            id="left"
          ></a-box>
          <a-box
            position="0.04 0 0"
            width="0.04"
            height="0.04"
            depth="0.02"
            color="gray"
            class="clickable"
            id="right"
          ></a-box>
        </a-entity>
        <a-entity position="0.18 -0.16 -0.4" id="zpad" visible="false">
          <a-cylinder
            position="0 -0.1 0"
            radius="0.02"
            height="0.02"
            color="red"
            rotation="90 0 0"
            class="clickable"
            id="forward"
          ></a-cylinder>
          <a-cylinder
            position="0 -0.15 0"
            radius="0.02"
            height="0.02"
            color="red"
            rotation="90 0 0"
            class="clickable"
            id="backward"
          ></a-cylinder>
        </a-entity>
        <a-entity position="-0.08 -0.15 -0.43" id="talkpad" visible="false">
          <a-entity
            position="0 0 0"
            scale="0.02 0.02 0.02"
            id="recordButton"
            class="clickable"
            gltf-model="{% static 'lobby/img_model/record_button.glb' %}"
          >
            <a-text
              value="not recording"
              align="center"
              position="0 0 0.011"
              scale="0.06 0.06 0.06"
              id="recordText"
            ></a-text>
          </a-entity>
        </a-entity>
        <!--í…ìŠ¤íŠ¸ ì…ë ¥ ë° ì§€ìš°ê¸° ë²„íŠ¼ìœ¼ë¡œ ì‚¬ìš©í•¨-->
        <a-entity position="-0.13 -0.1 -0.43" id="p-pad" visible="false">
          <a-box
            position="0 -0.05 0"
            width="0.04"
            height="0.04"
            depth="0.02"
            color="green"
            class="clickable"
            id="input-button"
          >
            <a-text
              value="INPUT"
              align="center"
              position="0 0 0.011"
            ></a-text>
          </a-box>
          <a-box
            position="0 -0.1 0"
            width="0.04"
            height="0.04"
            depth="0.02"
            color="red"
            class="clickable"
            id="eraser-button"
          >
            <a-text
              value="DEL"
              align="center"
              position="0 0 0.011"
            ></a-text>
          </a-box>
        </a-entity>
      </a-camera>
    </a-scene>
  </body>
  <script>
    document.getElementById('refreshProfile').addEventListener('click', function() {
      location.reload();  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    });
  </script>
  <script src="{% static 'lobby/js/text_translation.js' %}"></script>
  <script src="{% static 'lobby/js/record.js' %}"></script>
  <script src="{% static 'lobby/js/AR_function.js' %}"></script>
  <script src="{% static 'lobby/js/AR.js' %}"></script>
  <script src="{% static 'lobby/js/lobby.js' %}"></script>
</html>
